---
title: "Hypervolume_analyses"
author: "Patrick Alexander Walkden"
date: "29/10/2021"
output:
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
library(rgl)
setupKnitr(autoprint = TRUE)
knitr::knit_hooks$set(webgl = hook_webgl)
knitr::opts_chunk$set(echo = TRUE)
```

## Hypervolume Analyses

Following generating the species pool and performing randomisations it's time to look at how the occupancy of functional trait space as described by the TPD functions is distributed within each land-use and how the structure of this trait space differs across land-use types and compared to null communities. 

The structure of functional trait space characterized by hypervolumes can be described in a number of ways, as well as the typical metrics of Functional richness, divergence and evenness, a measure of "holeyness" can be determined. Holeyness within hypervolumes indicates empty functional space and potentially an unoccupied niche as a result of extinctions or trait combinations that are unfeasible in an environmental context.[REF x 2]

First, I am going to visualize the structure of occupied trait space across land uses within biogeographic realms 



```{r load in packages and data, echo = FALSE}
rm(list = ls())

## loading in tidyverse and the functions I have created to analyise and visualise the differences between TPD hypervolumes
require(tidyverse)#
require(ggpubr) # to aggregate plots
source("Functions/TPD_3D_plots.R")

## load in all the data

 PREDICTS_tpds <- readRDS("Outputs/PREDICTS_sites_tpds.rds") # morphometric TPDs of observed sites
 
 PREDICTS_randomisations <- readRDS("Outputs/randomisations_TPD_morpho.rds") ## morphometric TPD of randomisised sites 
 
 PREDICTS <- readRDS("Outputs/refined_predicts.rds") %>%  ## PREDICTS data 
   dplyr::distinct(SSBS, Predominant_habitat, Use_intensity, Biome, UN_subregion, Realm) %>% ## pull out land_use type, Subregion, realm etc
   dplyr::mutate(Predominant_habitat = ifelse(grepl(Predominant_habitat, pattern = "secondary", ignore.case = TRUE), "Secondary vegetation",
                                              paste(Predominant_habitat))) %>% data.frame() ## merge all secondary sites together
 
 
 species_TPD <- readRDS("Outputs/species_tpds_morpho.rds") ## individual species TPDs 

```

# site distribution

First things first, lets see how the sites that have a TPD calculated for them are distributed across land-uses and biogeographic realms.


```{r sites in lu and realm}
 


 TPD_LU <- data.frame(SSBS = names(PREDICTS_tpds)) %>% dplyr::left_join(PREDICTS) %>% dplyr::filter(Predominant_habitat != "Cannot decice",
                                                                                                    Use_intensity != "Cannot decide")

 table(TPD_LU$Predominant_habitat, TPD_LU$Realm)
```
I have decided to pool together sites with biogeographic realms as

Here we can see that there is quite an uneven spread of sites across the LU types and Realms so to check whether there are enough sites I am going to iteratively calculate functional diversity metrics for each LU-realm combination and if FD reaches an asymptote it will indicate that there are sufficent sites so that trait spaces can be compared.

```{r LU realm combos, echo = FALSE, cache=TRUE, message=FALSE, results = 'hide'}

### pull land_uses

land_uses <- PREDICTS %>% dplyr::distinct(Predominant_habitat, .keep_all = FALSE) %>% dplyr::filter(Predominant_habitat != "Cannot decide") %>% 
   pull() %>% as.character()

## pull realms 

realms <- as.character(unique(TPD_LU$Realm))
   
### get combinations of land uses and realms

combinations <- expand.grid(land_uses,realms) %>% set_colnames(c("land_use","realm"))

## check list for each combination I am adding each site in turn and calculating the resultant Functional Richness of the overall hypervolume - if the functional richness asymptotes before the sites run out then there are enough samples for the LUs to be compared  

if(any(grepl(list.files("Outputs"), pattern = "check_list"))){
 Check_list <- readRDS(grep(list.files("Outputs", full.names = TRUE), pattern = "check_list", value = TRUE)) 
} else {

  Check_list <- list()
  for(i in 1:nrow(combinations)){
  
    Land_use <- as.character(combinations[i,"land_use"])
    Realm <- as.character(combinations[i,"realm"])
    
    # This function will compute these metric and also produce a ggplot representation
    
    list <-   TPD_site_check(data = PREDICTS_tpds, LU = Land_use , realm = Realm)
    
    Check_list[[i]] <- list
    names(Check_list)[i] <- paste(Land_use, Realm, sep = "/")
  }
  write_rds("Outputs/realm_lu_check_list.rds", x = Check_list)
}
```
Now let's have a look! I have checked all the plot but I am going to exhibit just a couple here 

```{r realm checking}
sites <- c(1,11,31)

for(i in 1:length(Check_list)){
  
  if(is_empty(Check_list[[i]])){
    next()
  }
    figure <- Check_list[[i]]$ggplots
    figure <- annotate_figure(figure,
                    top = text_grob(paste(names(Check_list)[i]), color = "red", face = "bold", size = 14))

plot(figure)
}


```

So upon examining the plots there are a good number of LU/realm combinations that have sufficient sites to reasonably represent the occupancy of functional trait space.

Above are some examples of the variety of different patterns produced. Plantation forest in the Palearctic clearly is sufficeintly sampled. Pasture in the Afrotropics. although containing only a few sites does exhibit an asymptote and has been included for now but may need to be dropped later, and finally cropland in the Nearctic which is showing Functional richness is still increasing so therefore has not been sufficeintly sampled and therefore dropped. 

So....

In the Afrotropics we can compare Cropland, Pasture, Plantation forest, Primary forest, Primary non-forest and Secondary vegetation.

In Australasia we can compare Pasture, Primary forest, Primary non-forest and Secondary vegetation.

In Indo-Malay we can compare Cropland, Plantation forest, Primary forest, and Secondary vegetation.

In the Nearctic we can compare Cropland, Pasture, Primary forest, Primary non-forest and Secondary vegetation.

In the Neotropics we can compare Cropland, Pasture, Plantation forest, Primary forest, and Secondary vegetation.

In the Palearctic we can compare Cropland, Pasture, Plantation forest, Primary forest, Primary non-forest and Secondary vegetation.


Primary forest is the only land-use classification that is well represented ubiquitously across the realms, but there is also good coverage from secondary vegetation, plantation forest, pasture and, maybe, cropland. 

Urban and primary non-forest classifications are represented well in only three of the realms... maybe a case for combining primary sites together??

However, for now lets have a look at these trait spaces and use Primary forest sites in the Afrotropics as an example.


```{r site occupancy visualisation, webgl = TRUE}

pri_afro <- TPD_LU %>% dplyr::filter(Predominant_habitat == "Primary forest", Realm == "Afrotropic") %>% dplyr::distinct(SSBS) %>% pull()

TPD_3d_plot(data = PREDICTS_tpds, sites = pri_afro, T1lab = "Locomotion", T2lab = "Foraging", T3lab = "Body", method = "prob", title = "TPD_test_plot")

```

In this plot you can see a 3D plot representing the occupancy of trait space in the three dimensions characterised by our axes of the forgaing, locomotory and body niches. 

Scores on the body dimension track the size of the bird. 

High scores on the locomotory axis represent long tarsus' with slight increases in secondary wing lengths, while lower scores indicate longer tails and minor increases in wing length. 

The foraging niche is based on the dimensions of the beak and high scores representing wide, deep beaks and as scores decrease beaks tend towards those that are longer and thinner. 

It's all well and good being able to represent these trait spaces but what do they represent and how do they differ across land use gradients within biogeographic realms.

```{r FD_TPD metrics, fig.width= 10}

realm_land_uses <- list()
realm_land_uses[["Afrotropic"]] <- c("Primary forest","Primary non-forest", "Secondary vegetation","Plantation forest","Cropland","Pasture")
realm_land_uses[["Australasia"]] <- c("Primary forest","Primary non-forest", "Secondary vegetation", "Pasture")
realm_land_uses[["Indo-Malay"]] <- c("Primary forest","Secondary vegetation","Plantation forest","Cropland")
realm_land_uses[["Nearctic"]] <- c("Primary forest","Primary non-forest","Cropland", "Pasture", "Urban")
realm_land_uses[["Neotropic"]] <- c("Primary forest","Secondary vegetation","Plantation forest","Cropland","Pasture","Urban")
realm_land_uses[["Palearctic"]] <- c("Primary forest","Secondary vegetation", "Plantation forest","Cropland","Pasture","Urban")




for(r in realms){
  

    land_uses <- realm_land_uses[[r]]
  
  plot_data <- c()
  for(LU in land_uses){
  
  lu_sites <- TPD_LU %>% dplyr::filter(Predominant_habitat == LU, Realm == r) %>% dplyr::distinct(SSBS) %>% pull()
  
  metrics <- TPD_FD_metrics(data = PREDICTS_tpds, sites = lu_sites)
  metrics$Land_use <- LU
  metrics$group <- "individual_sites"
  metrics$group[nrow(metrics)] <- "combined_sites"
  metrics$group <- factor(metrics$group)
  plot_data <- rbind(plot_data,metrics)
  }
  
  plot_data$Land_use <- factor(plot_data$Land_use, levels = land_uses)
  
  
  p_rich <- ggplot(data = plot_data, aes(x = group, y = FRich)) +
    geom_boxplot(aes(fill = Land_use))
  
  p_div <- ggplot(data = plot_data, aes(x = group, y = FDiv)) +
    geom_boxplot(aes(fill = Land_use))
  
  p_eve <- ggplot(data = plot_data, aes(x = group, y = FEve)) +
    geom_boxplot(aes(fill = Land_use))
  
  p <- ggpubr::ggarrange(p_rich,p_div,p_eve, nrow = 1, common.legend = TRUE)
  
  p <- annotate_figure(p,
                    top = text_grob(paste(r,"Funtional Richness, divergence and eveness plots"), color = "red", face = "bold", size = 14))
  plot(p)
}

```
insert something about some interesting cases here 

## Differences between hypervolumes

Now let's calculate some beta-diversity metrics between the sites and characterise just how land use change is influencing the structure of functional trait space.

```{r site dissimlarity}

  dissim_list <- list()
  for(r in realms){
    
  
  land_uses <- realm_land_uses[[r]]
    
  LU_combo <- matrix(gtools::combinations(n = length(land_uses), r = 2, v = land_uses,set = TRUE), ncol = 2) %>% data.frame() %>% set_colnames(c("LU1","LU2"))
  
  
  array_dimnames <- list(c(land_uses),c(land_uses),c("Dissimilarity","Shared","Not_shared"))
  LU_array <- array(rep(NA,(length(land_uses)^2)*3),dim = c(length(land_uses),length(land_uses),3), dimnames = array_dimnames)
  
  for(i in 1:nrow(LU_combo)){
    
    
    sites_1 <- TPD_LU %>% dplyr::filter(Realm == r, Predominant_habitat == LU_combo[i,"LU1"]) %>% dplyr::distinct(SSBS) %>% pull()
    sites_2 <- TPD_LU %>% dplyr::filter(Realm == r, Predominant_habitat == LU_combo[i,"LU2"]) %>% dplyr::distinct(SSBS) %>% pull()
    
    dissimilarity <- Calc_dissim(data = PREDICTS_tpds,sites1 = sites_1, sites2 = sites_2)
    
    LU_array[LU_combo[i,"LU1"],LU_combo[i,"LU2"],"Dissimilarity"] <- dissimilarity[["dissim"]][["dissimilarity"]]
    LU_array[LU_combo[i,"LU1"],LU_combo[i,"LU2"],"Shared"] <- dissimilarity[["dissim"]][["P_shared"]]
    LU_array[LU_combo[i,"LU1"],LU_combo[i,"LU2"],"Not_shared"] <- dissimilarity[["dissim"]][["P_non_shared"]]
    
    LU_array[LU_combo[i,"LU2"],LU_combo[i,"LU1"],"Dissimilarity"] <- dissimilarity[["dissim"]][["dissimilarity"]]
    LU_array[LU_combo[i,"LU2"],LU_combo[i,"LU1"],"Shared"] <- dissimilarity[["dissim"]][["P_shared"]]
    LU_array[LU_combo[i,"LU2"],LU_combo[i,"LU1"],"Not_shared"] <- dissimilarity[["dissim"]][["P_non_shared"]]
  
    
    
     # TPD_Diff_plot(data = PREDICTS_tpds, sites1 = sites_1, sites2 =sites_2, T1lab = "Locomotion", T2lab = "Foraging",T3lab = "Body",
     #               method = "prob", title = paste("3D_TPD_Plot",LU_combo[i,"LU1"],LU_combo[i,"LU2"], sep = "_"), save = TRUE, file = paste("Outputs/TPD_3D_Plots/",r,"/",LU_combo[i,"LU1"],"_",LU_combo[i,"LU2"],"_difference_", "3dplot.png",sep = ""))
  }
    
  dissim_list[[r]][["dissim_array"]] <- LU_array
  
  
  }

source("Functions/PREDICTS_dissim_plot.R")

for(i in 1:length(dissim_list)){
PREDICTS_dissim_plot(dissim_list[[i]][[1]])
  title(main = paste(names(dissim_list)[i]))
}

```
### What areas of trait space are 


## Hypervolume holes


```{r hypervolume holes}

holes_frame <- c()

for(r in realms){
  
    
  land_uses <- realm_land_uses[[r]]
  
  
  hole_mat <- matrix(rep(NA,length(land_uses)*4), ncol = 4) %>% data.frame()
  rownames(hole_mat) <- land_uses
  colnames(hole_mat) <- c("total_hole_volume_int","proportion_to_observed_int","total_hole_volume_ext","proportion_to_observed_ext" )
  
  for(LU in land_uses){
  
  lu_sites <- TPD_LU %>% dplyr::filter(Predominant_habitat == LU, Realm == r) %>% dplyr::distinct(SSBS) %>% pull()
  
  
  holes <- TPD_holes(data = PREDICTS_tpds, randata = PREDICTS_randomisations, sites = lu_sites, threshold = 0.95)
  
  hole_mat[LU,] <- c(unlist(holes$internal[c("total_hole_volume","proportion_holes_volume")]),
                     unlist(holes$external[c("total_hole_volume","proportion_holes_volume")]))
  
  }
  
  hole_mat$Realm <- r
  hole_mat$Land_use <- rownames(hole_mat)
  hole_mat$Land_use <- factor(hole_mat$Land_use, levels = land_uses)
  
  holes_frame <- rbind(holes_frame,hole_mat)  
  
}

for(r in realms ){
 plot_data <- holes_frame %>% dplyr::filter(Realm == r)
  
  p_rich <- ggplot(data = plot_data, aes(x = Land_use, y = proportion_to_observed_int)) +
    geom_boxplot()
plot(p_rich)
}
 



```

## Where are these holes? What species occupy the empty space?

I'm going to put this on the HPc quickly as these checks do take a while!

```{r species in the holes}


species_pools <- readRDS("Outputs/predicts_sites_species_pools.rds")

if(any(grepl(x = list.files("Outputs"), pattern = "holey_species"))){
  holey_species <- readRDS(grep(list.files("Outputs", full.names = TRUE), value = TRUE, pattern = "holey_species"))
} else {
holey_species <- list()
for(r in realms){
  
  land_uses <- realm_land_uses[[r]]
  
  
  for(LU in land_uses){
  
  lu_sites <- TPD_LU %>% dplyr::filter(Predominant_habitat == LU, Realm == r) %>% dplyr::distinct(SSBS) %>% pull()
  
  
  holes <- TPD_holes(data = PREDICTS_tpds, randata = PREDICTS_randomisations, sites = lu_sites, threshold = 0.95)
  
  internal_species <- species_fit(holes[["internal"]][["internal_hole_cells"]][1:10,])
  
  holey_species[paste(r,LU,sep = "_")] <- internal_species
  }

}

holey_species <- readRDS("Outputs/holey_species.rds")

r <- "Afrotropic"

for(r in realms){

  lands_uses <- realm_land_uses[[r]]
  
  for(LU in land_uses){
  
    lu_sites <- TPD_LU %>% dplyr::filter(Predominant_habitat == LU, Realm == r) %>% dplyr::distinct(SSBS) %>% pull()
    
    pool_species <- c()
    for(sit in lu_sites){
      pool_species <- unique(c(pool_species,species_pools[[sit]][["0.9"]]))
    }
    
    holey_pool_species <- function(list){
      data <- list

      for(i in 1:nrow(data)){
        sp <- unlist(strsplit(data[i,"occupying_species"],split = "/"))
        data[i,"occupying_species"] <- paste(sp[which(sp %in% pool_species)], collapse = "/")
      }
      
      return(data)
    }

    holey_species <- lapply(holey_species, holey_pool_species)
        
}
}
write_rds(holey_species, file = "Outputs/holey_species.rds")
}

```






