---
title: "TPD_computation"
author: "Patrick Alexander Walkden"
date: "29/11/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## TPD computations

This markdown is going to walkthrough the computation of Trait Probability Density fucntions (TPDs) for each of the observed predicts communities in addition to calculating the mean TPD from the 1000 null communities generated previously. 

First things first... let's load in the relevant data and packages

```{r package and data loading}
rm(list = ls())

require(tidyverse)
require(TPD)
require(magrittr)

PREDICTS <- readRDS("Outputs/refined_predicts.rds") ### the cleaned PREDICTS data
TPD_traits <- readRDS("Outputs/full_morpho_traits_list.rds") ### The traits list for each species in the observed and null communities
drop_spp <- readRDS("Outputs/assembly_drop_spp.rds") ## Those species that need to be dropped
for_traits <- readRDS("Outputs/predicts_foraging_pcoa.rds") ### trait scores for the dietary guilds 

```

## Observed Communities 

PREDCITS needs a little cleaning before you can calculate TPDs we need to calculate each species relative abundance at each site. 

```{r pressure, echo=FALSE}
################### format PREDICTS data for TPD calculations

## filter out any species that need to be dropped 

TPD_data <- data.frame(PREDICTS) %>% filter(!(Birdlife_Name %in% drop_spp)) %>% 
  
  ## group by site and birdlife name a occasionally the sme species pops up in the same site twice.
  
  dplyr::group_by(SSBS,Birdlife_Name) %>% dplyr::mutate(SpeciesSiteAbundance = sum(Effort_Corrected_Measurement), n_spp = n()) %>%
  
  ## filter that that species isn't duplicated and then ungroup 
  
  filter(!duplicated(n_spp)| n_spp == 1) %>% ungroup() %>%
  
  #### group by site and calculate metrics of how many species are in each site and the total site abundance
  
  group_by(SSBS) %>% dplyr::mutate(Site_spp = n_distinct(Birdlife_Name),TotalSiteAbundance = sum(SpeciesSiteAbundance)) %>%
  
  ungroup() %>%
  
  #### calculate Relative abundance by dividing speices site abundance by total site abundance
  
  dplyr::mutate(RelativeAbundance = SpeciesSiteAbundance/TotalSiteAbundance) %>%
  
## droplevels
  droplevels() %>%
  
  #as data frame
  data.frame()
```

## Trait Probability Density (TPDs)

There are a couple of other functions that are necessary for the compatability of all the different computations. The first function creates the trait ranges that determine the breadth of the functional trait space upon which the species and communities will be cast onto.

The other is a function that calculates the 

```{r TPD functions}

# This function determines the breadth of the fucntional trait space in the three dimensions - as default the range buffer is 15% so adding that on to each end of the ranges 

trait_range_calc <- function(range, traits){
  
  ## the total range between max and min
  
  n_range_2 <- dist(c(min(traits[,2]),max(traits[,2])))[1]
  n_range_3 <- dist(c(min(traits[,3]),max(traits[,3])))[1]
  n_range_4 <- dist(c(min(traits[,4]),max(traits[,4])))[1]
  
  ## in a list get 15% and add to each end 
  
  trait_ranges <- list(c(min(traits[,2]) -(range * n_range_2),max(traits[,2]) + (range * n_range_2)),
                       c(min(traits[,3]) -(range * n_range_3),max(traits[,3]) + (range * n_range_3)),
                       c(min(traits[,4]) -(range * n_range_4),max(traits[,4]) + (range * n_range_4)))
  return(trait_ranges)
}


trait_ranges <- trait_range_calc(range = 0.15,traits = TPD_traits$complete_traits)


########################################################################################################
########################################################################################################
######## SPECIES TPD FUNCTION -- This function 

```



